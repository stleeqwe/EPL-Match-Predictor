/Users/stlee/Library/Python/3.9/lib/python/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
  warnings.warn(
Traceback (most recent call last):
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/test_e2e_comprehensive.py", line 187, in run_simulation
    for i, iter_result in enumerate(result['iteration_history'], 1):
KeyError: 'iteration_history'
Traceback (most recent call last):
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/simulation/v3/ai_integration.py", line 139, in generate_scenario
    scenario = self._dict_to_scenario(scenario_dict)
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/simulation/v3/ai_integration.py", line 529, in _dict_to_scenario
    for e in data['events']:
KeyError: 'events'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/test_e2e_comprehensive.py", line 145, in run_simulation
    result = simulator.simulate_match(match_input)
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/simulation/v3/match_simulator_v3.py", line 81, in simulate_match
    scenario = self.ai.generate_scenario(match_input)
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/simulation/v3/ai_integration.py", line 141, in generate_scenario
    raise AIClientError(f"Phase 1 Scenario 생성 실패: {e}")
simulation.v3.ai_integration.AIClientError: Phase 1 Scenario 생성 실패: 'events'
Traceback (most recent call last):
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/test_e2e_comprehensive.py", line 187, in run_simulation
    for i, iter_result in enumerate(result['iteration_history'], 1):
KeyError: 'iteration_history'

======================================================================
🚀 COMPREHENSIVE E2E TEST SUITE
======================================================================

Testing Domain Knowledge → AI Scenario → Simulation Pipeline
All tests use REAL Qwen AI (no mocks)

======================================================================

======================================================================
🔧 Qwen AI Setup
======================================================================
✅ Qwen AI is ready!




██████████████████████████████████████████████████████████████████████
TEST 1: Strong Team vs Weak Team
██████████████████████████████████████████████████████████████████████

======================================================================
🎮 Test Scenario: Strong vs Weak
======================================================================

📋 Match Setup:
  Home: Manchester City
    - Attack: 92.0, Defense: 88.0
    - Press: 85.0, Style: possession
    - Form: WWWWW, Injuries: 0

  Away: Sheffield United
    - Attack: 55.0, Defense: 58.0
    - Press: 52.0, Style: direct
    - Form: LLLLD, Injuries: 2

  Venue: Etihad Stadium
  Importance: regular

⚡ Running simulation (max 3 iterations)...
  (This may take 1-2 minutes depending on AI response time...)

============================================================
Match Simulator V3: Manchester City vs Sheffield United
============================================================

Phase 1: AI 시나리오 생성...
  ✅ 시나리오 생성 완료: 4개 이벤트

📊 Adaptive Threshold: 0.536 (Base: 0.600)
  전력 차이: 33.5 → -0.067
  스타일 유사도: 0.00 → +0.000
  Form 변동성: 0.10 → +0.003

--- Iteration 1/3 ---
Phase 2: Statistical Engine 시뮬레이션...
  최종 스코어: 3-1
  서사 일치율: 0%
Phase 3: AI 분석/조정...
  AI 상태: needs_adjustment
Phase 4: 수렴 판단...
  수렴 점수: 0.12
  수렴 여부: ❌ No
  📌 New best score: 0.12
Phase 5: 시나리오 조정...
  ✅ Smoothing 적용 완료 (α=0.33)

--- Iteration 2/3 ---
Phase 2: Statistical Engine 시뮬레이션...
  최종 스코어: 4-1
  서사 일치율: 17%
Phase 3: AI 분석/조정...
  AI 상태: needs_adjustment
Phase 4: 수렴 판단...
  수렴 점수: 0.31
  수렴 여부: ❌ No
  📌 New best score: 0.31
Phase 5: 시나리오 조정...
  ✅ Smoothing 적용 완료 (α=0.36)

--- Iteration 3/3 ---
Phase 2: Statistical Engine 시뮬레이션...
  최종 스코어: 3-3
  서사 일치율: 14%
Phase 3: AI 분석/조정...
  AI 상태: converged
Phase 4: 수렴 판단...
  수렴 점수: 0.65
  수렴 여부: ✅ Yes
  📌 New best score: 0.65

✅ 수렴 완료! (Iteration 3)

Phase 7: 최종 리포트 생성...
  ✅ 리포트 생성 완료 (1803 문자)

============================================================
✅ 시뮬레이션 완료!
============================================================


======================================================================
📊 Simulation Results
======================================================================

✅ Final Score: 3-3
✅ Iterations: 3/3
✅ Convergence Score: 0.65
✅ Converged: True
✅ Narrative Adherence: 14%
✅ Execution Time: 177.1s

📈 Match Statistics:
  Shots: 21 - 17
  Possession: 35% - 55%
  xG: 0.00 - 0.00

🎬 AI Scenario Analysis:

🔄 Convergence Process:

❌ Simulation failed after 177.1s: 'iteration_history'

❌ Test 'Strong vs Weak' FAILED



██████████████████████████████████████████████████████████████████████
TEST 2: Balanced Top Clash
██████████████████████████████████████████████████████████████████████

======================================================================
🎮 Test Scenario: Balanced Top Clash
======================================================================

📋 Match Setup:
  Home: Arsenal
    - Attack: 85.0, Defense: 82.0
    - Press: 88.0, Style: possession
    - Form: WWDWL, Injuries: 1

  Away: Liverpool
    - Attack: 87.0, Defense: 80.0
    - Press: 85.0, Style: mixed
    - Form: WWLWW, Injuries: 0

  Venue: Emirates Stadium
  Importance: top_clash

⚡ Running simulation (max 4 iterations)...
  (This may take 1-2 minutes depending on AI response time...)

============================================================
Match Simulator V3: Arsenal vs Liverpool
============================================================

Phase 1: AI 시나리오 생성...

❌ Simulation failed after 71.6s: Phase 1 Scenario 생성 실패: 'events'

❌ Test 'Balanced Top Clash' FAILED



██████████████████████████████████████████████████████████████████████
TEST 3: Possession vs Direct Style
██████████████████████████████████████████████████████████████████████

======================================================================
🎮 Test Scenario: Possession vs Direct
======================================================================

📋 Match Setup:
  Home: Brighton
    - Attack: 75.0, Defense: 72.0
    - Press: 82.0, Style: possession
    - Form: WDWDW, Injuries: 0

  Away: Burnley
    - Attack: 68.0, Defense: 75.0
    - Press: 65.0, Style: direct
    - Form: DWLWD, Injuries: 1

  Venue: Amex Stadium
  Importance: regular

⚡ Running simulation (max 3 iterations)...
  (This may take 1-2 minutes depending on AI response time...)

============================================================
Match Simulator V3: Brighton vs Burnley
============================================================

Phase 1: AI 시나리오 생성...
  ✅ 시나리오 생성 완료: 5개 이벤트

📊 Adaptive Threshold: 0.611 (Base: 0.600)
  전력 차이: 2.0 → -0.004
  스타일 유사도: 0.00 → +0.000
  Form 변동성: 0.50 → +0.015

--- Iteration 1/3 ---
Phase 2: Statistical Engine 시뮬레이션...
  최종 스코어: 1-2
  서사 일치율: 0%
Phase 3: AI 분석/조정...
  AI 상태: needs_adjustment
Phase 4: 수렴 판단...
  수렴 점수: 0.12
  수렴 여부: ❌ No
  📌 New best score: 0.12
Phase 5: 시나리오 조정...
  ✅ Smoothing 적용 완료 (α=0.33)

--- Iteration 2/3 ---
Phase 2: Statistical Engine 시뮬레이션...
  최종 스코어: 1-4
  서사 일치율: 0%
Phase 3: AI 분석/조정...
  AI 상태: needs_adjustment
Phase 4: 수렴 판단...
  수렴 점수: 0.15
  수렴 여부: ✅ Yes
  📌 New best score: 0.15

✅ 수렴 완료! (Iteration 2)

Phase 7: 최종 리포트 생성...
  ✅ 리포트 생성 완료 (1543 문자)

============================================================
✅ 시뮬레이션 완료!
============================================================


======================================================================
📊 Simulation Results
======================================================================

✅ Final Score: 1-4
✅ Iterations: 2/3
✅ Convergence Score: 0.15
✅ Converged: True
✅ Narrative Adherence: 0%
✅ Execution Time: 192.0s

📈 Match Statistics:
  Shots: 15 - 14
  Possession: 39% - 51%
  xG: 0.00 - 0.00

🎬 AI Scenario Analysis:

🔄 Convergence Process:

❌ Simulation failed after 192.0s: 'iteration_history'

❌ Test 'Possession vs Direct' FAILED



Traceback (most recent call last):
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/test_e2e_comprehensive.py", line 145, in run_simulation
    result = simulator.simulate_match(match_input)
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/simulation/v3/match_simulator_v3.py", line 158, in simulate_match
    smoothed_scenario = self.ai.apply_scenario_smoothing(
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/simulation/v3/ai_integration.py", line 364, in apply_scenario_smoothing
    return Scenario(
  File "<string>", line 6, in __init__
  File "/Users/stlee/Desktop/EPL-Match-Predictor/backend/ai/data_models.py", line 151, in __post_init__
    assert 3 <= len(self.events) <= 10, \
AssertionError: 이벤트는 3-10개여야 함: 13개
